
<html>
    <head>
        <title>Shooting at Stuff</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
         <script type="text/javascript" src="javascript/dis.js"></script>
    </head>
    <body onLoad="initialize()">
        
        <h2>Shooting Test</h2><br>
        <form id="FireForm" action="form_action.asp">
                <b>Fire PDU Information</b><br>
                  Firing Entity ID: <input type="text" name="siteID" id="siteID" value="17">,
                                    <input type="text" name="applicationID" id="applicationID" value="42">,
                                    <input type="text" name="entityID" id="entityID" value="1"><br>
                  Target Entity ID: <input type="text" name="tSiteID" id="tSiteID" value="17">,
                                    <input type="text" name="tApplicationID" id="tApplicationID" value="42">,
                                    <input type="text" name="tEntityID" id="tEntityID" value="88"><br>
                  Munition Type : <select id="ammo"> 
                      <option value="40mmGrenade">40mm Grenade</option>
                      <option value="556Rifle">5.56 Rifle</option>
                  </select><br>
                  Shooter Location (Lat/Lon/Alt):<input type="text" name="sLat" id="sLat" value="36.7">,
                                    <input type="text" name="sLon" id="sLon" value="-121.3">,
                                    <input type="text" name="sAlt" id="sAlt" value="1"><br>
                      <br>
                 <br>
                 <input type="button" name="fireMunition" value="Fire" onClick="fire()" >
                 <br>
        </form>
        
        <p>
            
       <form id="DetonationForm" action="form_action.asp">
          <b>Detonation PDU Information</b><br>
                  Firing Entity ID: <input type="text" name="siteID" id="dfSiteID" value="17">,
                                    <input type="text" name="applicationID" id="dfApplicationID" value="42">,
                                    <input type="text" name="entityID" id="dfEntityID" value="1"><br>
                                    
                  Target Entity ID: <input type="text" name="tSiteID" id="dtSiteID" value="88">,
                                    <input type="text" name="tApplicationID" id="dtApplicationID" value="18">,
                                    <input type="text" name="tEntityID" id="dtEntityID" value="1"><br>
                  
                  Detonation Location (Lat/Lon/Alt):<input type="text" name="dLat" id="dLat" value="31.4426">,
                                    <input type="text" name="sLon" id="dLon" value="45.2273,">,
                                    <input type="text" name="sAlt" id="dAlt" value="1034.5"><br>
                      <br>
                      
                 <br>
                 <input type="button" name="det" value="Detonation" onClick="detonation()" >
                 <br>
        </form>
        
        <SCRIPT type="text/javascript">
    /** This works if you're running client and server on one host. To 
     * have it work with a remote server, replace localhost with the IP
     * or name of the server.
     */
    var WEBSOCKET_URL="ws://localhost:8282";
    var websocket;
    /** A likely map location */
    var montereyLocation = {'latitude':36.595, 'longitude':-121.877};
    var allEntities = new Object();
    var pduFactory = new dis.PduFactory();
    var eventIdentifier = 1;
    var eventIndex = 1;
                     
   function fire()
   {
       console.log("bang");
       var firePdu = new dis.FirePdu();
       firePdu.firingEntityID.site = parseInt(document.getElementById("siteID").value);
       firePdu.firingEntityID.application = parseInt(document.getElementById("applicationID").value);
       firePdu.firingEntityID.entity = parseInt(document.getElementById("entityID").value);
       
       firePdu.targetEntityID.site = parseInt(document.getElementById("tSiteID").value);
       firePdu.targetEntityID.application = parseInt(document.getElementById("tApplicationID").value);
       firePdu.targetEntityID.entity = parseInt(document.getElementById("tEntityID").value);
       
       // Position
       var lat = parseFloat(document.getElementById("sLat").value);
       var lon = parseFloat(document.getElementById("sLon").value);
       var alt = parseFloat(document.getElementById("sAlt").value);
                
       // Convert lat/lon/alt to DIS coordinates
       var conversion = new dis.CoordinateConversion();
       latLonAlt = {};
       latLonAlt.lat = lat;
       latLonAlt.lon = lon;
       latLonAlt.alt = alt;

       var disCoordinates = conversion.getXYZfromLatLonAltDegrees(latLonAlt);
       firePdu.locationInWorldCoordinates.x = disCoordinates.x;
       firePdu.locationInWorldCoordinates.y = disCoordinates.y;
       firePdu.locationInWorldCoordinates.z = disCoordinates.z;
       console.log("Location:", disCoordinates);

       // Ammo type being shot
       var ammoSelect = document.getElementById("ammo");
       var ammo = ammoSelect.options[ammoSelect.selectedIndex].value;
       console.log("Ammo type: ", ammo);
       
       switch(ammo)
       {
           case "40mmGrenade":
              // create a 40mm grenade munition
               break;
               
            case "556Rifle":
                // create a 5.56 rifle munitiom
                break;
                
            default:
                break;
       }
       
       eventIndex++;
       firePdu.eventID.eventNumber = eventIndex;
       
       // create and send fire PDU
      var dataBuffer = new ArrayBuffer(1000); // typically 144 bytes, make it bigger for safety
      var outputStream = new dis.OutputStream(dataBuffer);
      firePdu.encodeToBinary(outputStream);
      var trimmedData = outputStream.toByteArray();
      websocket.send(trimmedData);
      console.log("Sent pdu ", firePdu);
 
   }
   
   /**
    * Create and send a detonation PDU
    * @returns {undefined}
    */
   function detonation()
   {
       var detonationPdu = new dis.DetonationPdu();
       console.log(detonationPdu);

       detonationPdu.firingEntityID.site = parseInt(document.getElementById("dfSiteID").value);
       detonationPdu.firingEntityID.application = parseInt(document.getElementById("dfApplicationID").value);
       detonationPdu.firingEntityID.entity = parseInt(document.getElementById("dfEntityID").value);
       
       detonationPdu.targetEntityID.site = parseInt(document.getElementById("dtSiteID").value);
       detonationPdu.targetEntityID.application = parseInt(document.getElementById("dtApplicationID").value);
       detonationPdu.targetEntityID.entity = parseInt(document.getElementById("dtEntityID").value);
       
       // Munition Type for AIM-9 Sidewinder
       detonationPdu.burstDescriptor.munition.entityKind = 2;
       detonationPdu.burstDescriptor.munition.domain = 1;
       detonationPdu.burstDescriptor.munition.country = 225;
       detonationPdu.burstDescriptor.munition.category = 1;
       detonationPdu.burstDescriptor.munition.subcategory = 1;
       detonationPdu.burstDescriptor.munition.spec = 0;
       detonationPdu.burstDescriptor.munition.extra = 0;
       detonationPdu.burstDescriptor.warhead = 0;
       detonationPdu.burstDescriptor.fuse = 0;
       detonationPdu.burstDescriptor.quantity = 1;
       detonationPdu.burstDescriptor.rate = 0;

       // Position
       var lat = parseFloat(document.getElementById("dLat").value);
       var lon = parseFloat(document.getElementById("dLon").value);
       var alt = parseFloat(document.getElementById("dAlt").value);
                
       // Convert lat/lon/alt to DIS coordinates
       var conversion = new dis.CoordinateConversion();
       latLonAlt = {};
       latLonAlt.lat = lat;
       latLonAlt.lon = lon;
       latLonAlt.alt = alt;

       var disCoordinates = conversion.getXYZfromLatLonAltDegrees(latLonAlt);
       detonationPdu.locationInWorldCoordinates.x = disCoordinates.x;
       detonationPdu.locationInWorldCoordinates.y = disCoordinates.y;
       detonationPdu.locationInWorldCoordinates.z = disCoordinates.z;
       
       var dataBuffer = new ArrayBuffer(1000); // typically 144 bytes, make it bigger for safety
       var outputStream = new dis.OutputStream(dataBuffer);
       detonationPdu.encodeToBinary(outputStream);
       var binaryData = outputStream.toByteArray();
       websocket.send(binaryData);
       console.log("Sent pdu ", detonationPdu);
      
   }

    /**
     * Initialize websocket
     * 
     * @returns {undefined}
     */
    function initialize()
    {
        websocket = new WebSocket(WEBSOCKET_URL);

        // Set the format we want to use to receive binary messages
         websocket.binaryType = 'arraybuffer';

         // Attach functions to the the web socket for various events
         websocket.onopen = function(evt){console.log("Opened websocket");};//console.log("websocket onopen");};
         websocket.onclose = function(evt){console.log("websocket close", evt);};
         websocket.onerror = function(evt){console.log("websocket error", evt.data);};

         websocket.onmessage = function(evt)
         { 
             //console.log("Received message");
             var disMessage = pduFactory.createPdu(evt.data);

             switch(disMessage.pduType)
             {
                case 1: 
                    //console.log("ESPDU");
                    var entityId = disMessage.entityID;
                    var eidString = JSON.stringify(entityId);
                    var theEntity = allEntities[eidString];
                    if(theEntity === undefined)
                    {
                        /*
                        allEntities[eidString] = disMessage;
                        console.log("Entity database:")
                        console.log("--");
                        console.log(allEntities);
                        console.log("--");
                        */
                    }
                    break;

                default:
                    break;
             }
         };

    }

            
            
            </script>
    </body>
</html>
